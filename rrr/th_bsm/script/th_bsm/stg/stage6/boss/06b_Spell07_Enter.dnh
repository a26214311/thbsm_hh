#����e����[Single]
#ScriptVersion[3]
#Title["���X�y�������ւ���"]
#Text["���X�y�������ւ���"]
#Background[""]
#System["./../../../system/System.dnh"]

//---------------------------------------------------------------------

// �֐���荞��
#include"./../../../lib/lib_boss.dnh"
#include"./../../../lib/lib_talk.dnh"
#include"./lib_Mishandra.dnh"
#include"./06b_Spell07_Func.dnh"

@Event {
	alternative(GetEventType())
	case(EV_REQUEST_LIFE)		{ SetScriptResult(1);	}
	case(EV_REQUEST_TIMER)		{ SetScriptResult(-1);		}
	BossEvent();
}

@Initialize {
	bossDropItem = 0;	//�A�C�e����
	
	Boss_Init();	//����ݒ�
	objEnemy = CreateBossTalk(BOSS_ID_MISHANDRA);	//�{�X�Z�b�g

	Task_Main();
}

@MainLoop {
	yield;
}

// ���C���^�X�N
task Task_Main
{
	let to_x = CenX;
	let to_y = 140;

	// �ړ�����W���Z�b�g
	ObjMove_SetPosition(objEnemy, to_x, to_y);
	// ���@�w���Z�b�g
	BossEffect_ResetMagicCircle();
	
	ENTER_EFFECT();
	wait(420);
	
	// ��b����
	StartTalk();
	
	wait(60);
	
	// ��b
	FuncTalk();
	FinishTalk(true);

	// �I�v�V����
	FumaCharismaOption_LS(objEnemy, true);
	wait(240);
	// ���@�w�ݒu
	DisplayShake(150, 4);
	FumaCharismaOption_MC_LS(objEnemy, [GetStgFrameWidth/2, 400], true, true);
	wait(120);
	SetFamilier01(GetStgFrameWidth/2+92, 200, 90+45,  1, 0, 150);
	SetFamilier01(GetStgFrameWidth/2-92, 200, 90-45, -1, 0, 150);
	CallSound(sndBoon);
	
	wait(120);
	
	let objDummy = CreateShotA1(GetStgFrameWidth/2, 220, 0, 0, BGW_BALL_S_RED, 0);
	SetShotDisabled(objDummy);
	Obj_SetVisible(objDummy, false);

	CallSound(sndPower1);
	DisplayShake(180, 8);
	ascent(i in 0 .. 6)
	{
		EffectConcentrationLine(objDummy,
			[EFF_RED,EFF_YELLOW,EFF_GREEN,EFF_SKY,EFF_BLUE,EFF_WHITE][i],
			75, 6+i);
		wait(15);
	}
	wait(30);
	Mishandra_HideBossEffect(true);
	
	CallSound(sndCallSpellCard);
	loop(30)
	{
		loop(10)
		{
			S07DigitalEffect3(GetStgFrameWidth/2+rand(-64,64), 200+rand(-64,64),
				rand(1, 5), rand(0,360), rand_int(0,1));
		}
		yield;
	}
	Boss_Finalize(objEnemy, false, false);
}

// �J�n���o
task ENTER_EFFECT()
{
	// �{�X�o��p
	EnterBoss();

	// �w�i�z�u
	let idBG = LoadScript(GetCurrentScriptDirectory()~"06c_Background.dnh");
	StartScript(idBG);
	
	// BGM
	PlayMusicWithName(14, 240, 30);
	wait(240);

	// �X�e�[�W�w�i�폜
	NotifyEvent(GetStageBG_ID(), ev_CloseScript, 2);
}

// ��b����
function FuncTalk()
{
	// �I�u�W�F�N�g�쐬
	let cutinBoss1   = CreateTalkObject(BOSS_ID_MISHANDRA, true);
	
	// ����ݒ�
	SetImageFoward(cutinBoss1, true);
	ChangeTalkTexture(cutinBoss1, I_NORMAL2);
	BossScene_SetNameVisible(objScene, false);	//�{�X�l�[���\�����
	wait(15);
	
	let talkID = 0;
	loop
	{
		let talkType = FuncTalkSingle(talkID);
		if (talkType == 0) { break; }
		talkID = max(0, talkID+WaitNextTimer(60));
	}

	// ��b�����P���i�����߂����o����悤�Ɂj
	function FuncTalkSingle(talkID)
	{
		let talk_type = 1;
		alternative(talkID)
		case(0)
		{
			ChangeTalkTexture(cutinBoss1, I_NORMAL2);
SetTalkEx(cutinBoss1, gettxt("06b_Spell07_Enter.dnh.1",GetAreaCommonData("Config", "AccKey", 0)));
			wait(105);
		}
		case(1)
		{
			ChangeTalkTexture(cutinBoss1, I_NORMAL);
SetTalkEx(cutinBoss1, gettxt("06b_Spell07_Enter.dnh.2",GetAreaCommonData("Config", "AccKey", 0)));
			wait(105);
		}
		case(2)
		{
			ChangeTalkTexture(cutinBoss1, I_NORMAL3);
SetTalkEx(cutinBoss1, gettxt("06b_Spell07_Enter.dnh.3",GetAreaCommonData("Config", "AccKey", 0)));
			wait(105);
		}
		case(3)
		{
			ChangeTalkTexture(cutinBoss1, I_NORMAL);
SetTalkEx(cutinBoss1, gettxt("06b_Spell07_Enter.dnh.4",GetAreaCommonData("Config", "AccKey", 0)));
			wait(105);
		}
		case(4)
		{
			ChangeTalkTexture(cutinBoss1, I_NORMAL2);
SetTalkEx(cutinBoss1, gettxt("06b_Spell07_Enter.dnh.5",GetAreaCommonData("Config", "AccKey", 0)));
			wait(105);
		}
		case(5)
		{
			ChangeTalkTexture(cutinBoss1, I_NORMAL);
SetTalkEx(cutinBoss1, gettxt("06b_Spell07_Enter.dnh.6",GetAreaCommonData("Config", "AccKey", 0)));
			wait(105);
		}
		case(6)
		{
			ChangeTalkTexture(cutinBoss1, I_NORMAL2);
SetTalkEx(cutinBoss1, gettxt("06b_Spell07_Enter.dnh.7",GetAreaCommonData("Config", "AccKey", 0)));
			SetFukidashiType(cutinBoss1, FUKIDASHI_ANGER);	// �����o���^�C�v�ύX
			wait(135);
		}
		others
		{
			return(0);
		}
		return(talk_type);
	}
}

// �o�ꃂ�[�V����
task EnterBoss()
{
	if (Obj_GetValueD(objEnemy, "BOSS_MOVED", false)) { return; }
	Obj_SetValue(objEnemy, "BOSS_MOVED", true);
	
	let objImg = GetBossImageID(objEnemy);
	ObjRender_SetAlpha(objImg, 0);
	wait(420);
	ascent(t in 0 .. 120)
	{
		let tmp = (t+1)/120;
		ObjRender_SetAlpha(objImg, tmp*255);
		yield;
	}
}

// �t�[�}�X�S�C�n���h
task SetFamilier01(iniX, iniY, iniAngle, iniMuki, iniValue, iniTimer)
{
	let eSize = ENEMY_M;
	let eColor = EFF_RED;
	let item_count = 0;
	let item_star = 0;
	let baseAngle = iniAngle;
	let baseAdd = 0;
	
	let objFamilier = MakeEnemyFamilier(iniX, iniY, 99999, eSize);
	SetDropItemCount(objFamilier, item_count, item_star);
	DrawMishandraHand(objFamilier, iniAngle, iniMuki);
	TAct();
	WaitForKilledFamilier(objFamilier, 0, 0);
	ZakoFinalize(objFamilier, eColor);
	
	task TAct()
	{
		wait(iniTimer);
		ChangeMishandraHandShuffle(objFamilier, 180);
		wait(90);
		ObjMove_SetSpeed(objFamilier, 0);
		ObjMove_SetAcceleration(objFamilier, 0.5);
		ObjMove_SetMaxSpeed(objFamilier, 10);
		ObjMove_SetAngle(objFamilier, iniAngle+180);
	}
	
}
